#!/usr/bin/env bash

set -o pipefail

VERSION="9.17.1"
HIGHLIGHT_JS_RELEASE_URL="https://github.com/highlightjs/highlight.js/archive/$VERSION.tar.gz"
TMP_DIR="tmp"
INVALID_CHARACTER_THAT_HIDES_IN_BUILD=""
HIGHLIGHT_JS_SOURCE_PATH="$TMP_DIR/highlight.js-$VERSION"
PACK_FILE="$HIGHLIGHT_JS_SOURCE_PATH/build/highlight.pack.js"
GENERATED_FILES_PATH="Sources/HighlightJS/Generated"
SWIFT_WRAPPER_FILE="$GENERATED_FILES_PATH/highlightPackJSSourceCode.swift"

mkdir -p $TMP_DIR
echo "Downloading '$HIGHLIGHT_JS_RELEASE_URL'."
wget -qO- $HIGHLIGHT_JS_RELEASE_URL | tar xz - -C $TMP_DIR

echo "Installing npm dependencies."
(cd "$TMP_DIR/highlight.js-$VERSION" && npm install)
(cd "$TMP_DIR/highlight.js-$VERSION" && node tools/build.js)

# In the highlight js source code the use "\x7f" for some reason and that ends
# up as "" in the build. That character can't be understood by swift so we
# replace it back to the character that it was in the source code before build.
sed -i '' 's//\\x7f/g' $PACK_FILE

echo "Generate swift wrapper file at '$SWIFT_WRAPPER_FILE'."
mkdir -p $GENERATED_FILES_PATH
echo "/**" > $SWIFT_WRAPPER_FILE
echo "-- Below is the LICENSE for highlight.js --" >> $SWIFT_WRAPPER_FILE
echo "-------------------------------------------" >> $SWIFT_WRAPPER_FILE
echo "$(cat $HIGHLIGHT_JS_SOURCE_PATH/LICENSE)" >> $SWIFT_WRAPPER_FILE
echo "-------------------------------------------" >> $SWIFT_WRAPPER_FILE
echo "--------- END highlight.js LICENSE --------" >> $SWIFT_WRAPPER_FILE
echo "*/" >> $SWIFT_WRAPPER_FILE
echo "" >> $SWIFT_WRAPPER_FILE
echo "/// The javascript source code for highlight js version $VERSION" >> $SWIFT_WRAPPER_FILE
echo "/// Generated by bin/generate_highlight_js_swift_wrapper" >> $SWIFT_WRAPPER_FILE
echo 'var highlightPackJSSourceCode = ###"""' >> $SWIFT_WRAPPER_FILE
echo "$(cat $PACK_FILE)" >> $SWIFT_WRAPPER_FILE
echo '"""###' >> $SWIFT_WRAPPER_FILE
